name: CI - Client Registry

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate JSON syntax
        shell: bash
        run: |
          set -euo pipefail
          echo "Validating clients.json syntax..."
          jq empty clients.json
          echo "✅ JSON syntax valid"

      - name: Validate JSON structure
        shell: bash
        run: |
          set -euo pipefail
          echo "Checking total_clients consistency..."
          
          total=$(jq '.total_clients' clients.json)
          actual=$(jq '.clients | length' clients.json)
          
          if [ "$total" -ne "$actual" ]; then
            echo "❌ total_clients ($total) != actual count ($actual)"
            exit 1
          fi
          
          echo "✅ total_clients matches actual count: $total"

      - name: Check for empty registry
        shell: bash
        run: |
          set -euo pipefail
          echo "Checking registry is not empty..."
          
          count=$(jq '.clients | length' clients.json)
          
          if [ "$count" -eq 0 ]; then
            echo "❌ Registry is empty (no clients)"
            exit 1
          fi
          
          echo "✅ Registry has $count client(s)"

      - name: Validate required fields (strict)
        shell: bash
        run: |
          set -euo pipefail
          echo "Validating required fields with type checking..."
          
          # Check for missing or invalid required fields
          missing=$(jq -r '
            .clients[]
            | select(
                (.slug|type) != "string" or (.slug|length) == 0
                or (.name|type) != "string" or (.name|length) == 0
                or (.tier|type) != "string" or (.tier|length) == 0
                or (.pod|type) != "string" or (.pod|length) == 0
                or (.stack|type) != "string" or (.stack|length) == 0
                or (.id|type) != "string" or (.id|length) == 0
              )
            | .slug // .id // "<unknown>"
          ' clients.json || true)
          
          if [ -n "$missing" ]; then
            echo "❌ Missing/invalid required fields in clients:"
            echo "$missing"
            exit 1
          fi
          
          echo "✅ All required fields present and valid"

      - name: Validate slug pattern
        shell: bash
        run: |
          set -euo pipefail
          echo "Validating slug patterns (lowercase, hyphens only)..."
          
          bad_slugs=$(jq -r '
            .clients[].slug
            | select(test("^[a-z0-9]+(?:-[a-z0-9]+)*$") | not)
          ' clients.json || true)
          
          if [ -n "$bad_slugs" ]; then
            echo "❌ Invalid slug format (must be lowercase with hyphens):"
            echo "$bad_slugs"
            exit 1
          fi
          
          echo "✅ All slugs valid"

      - name: Check for duplicate slugs
        shell: bash
        run: |
          set -euo pipefail
          echo "Checking for duplicate slugs..."
          
          slugs=$(jq -r '.clients[].slug' clients.json | sort)
          duplicates=$(echo "$slugs" | uniq -d)
          
          if [ -n "$duplicates" ]; then
            echo "❌ Duplicate slugs found:"
            echo "$duplicates"
            exit 1
          fi
          
          echo "✅ No duplicate slugs"

      - name: Check for duplicate IDs
        shell: bash
        run: |
          set -euo pipefail
          echo "Checking for duplicate IDs..."
          
          ids=$(jq -r '.clients[].id' clients.json | sort)
          duplicates=$(echo "$ids" | uniq -d)
          
          if [ -n "$duplicates" ]; then
            echo "❌ Duplicate IDs found:"
            echo "$duplicates"
            exit 1
          fi
          
          echo "✅ No duplicate IDs"

      - name: Validate enums (tier, pod, stack)
        shell: bash
        run: |
          set -euo pipefail
          echo "Validating enum values..."
          
          # Allowed tiers
          invalid_tier=$(jq -r '
            .clients[].tier
            | select(. as $t | ["beta", "standard", "premium", "enterprise"] | index($t) | not)
          ' clients.json || true)
          
          if [ -n "$invalid_tier" ]; then
            echo "❌ Invalid tier value: $invalid_tier"
            echo "Allowed: beta, standard, premium, enterprise"
            exit 1
          fi
          
          # Allowed pods
          invalid_pod=$(jq -r '
            .clients[].pod
            | select(. as $p | ["corporate", "ecommerce", "enterprise", "education", "healthcare", "government"] | index($p) | not)
          ' clients.json || true)
          
          if [ -n "$invalid_pod" ]; then
            echo "❌ Invalid pod value: $invalid_pod"
            echo "Allowed: corporate, ecommerce, enterprise, education, healthcare, government"
            exit 1
          fi
          
          # Allowed stacks
          invalid_stack=$(jq -r '
            .clients[].stack
            | select(. as $s | ["laravel", "node", "nextjs", "wordpress", "custom"] | index($s) | not)
          ' clients.json || true)
          
          if [ -n "$invalid_stack" ]; then
            echo "❌ Invalid stack value: $invalid_stack"
            echo "Allowed: laravel, node, nextjs, wordpress, custom"
            exit 1
          fi
          
          echo "✅ All enum values valid"

      - name: Validate gates are booleans
        shell: bash
        run: |
          set -euo pipefail
          echo "Validating gates are boolean values..."
          
          invalid_gates=$(jq -r '
            .clients[]
            | .gates
            | to_entries[]
            | select(.value | type != "boolean")
            | "\(.key) in \(.value)"
          ' clients.json || true)
          
          if [ -n "$invalid_gates" ]; then
            echo "❌ Gates must be boolean (true/false):"
            echo "$invalid_gates"
            exit 1
          fi
          
          echo "✅ All gates are boolean"

      - name: Validate date formats
        shell: bash
        run: |
          set -euo pipefail
          echo "Validating date formats (YYYY-MM-DD)..."
          
          invalid_dates=$(jq -r '
            .clients[]
            | [.created, .updated]
            | .[]
            | select(test("^[0-9]{4}-[0-9]{2}-[0-9]{2}$") | not)
          ' clients.json || true)
          
          if [ -n "$invalid_dates" ]; then
            echo "❌ Invalid date format (must be YYYY-MM-DD):"
            echo "$invalid_dates"
            exit 1
          fi
          
          echo "✅ All dates valid"

      - name: Validate JSON Schema
        shell: bash
        run: |
          set -euo pipefail
          echo "Validating against JSON Schema..."
          
          if [ -f schemas/clients.schema.json ]; then
            npx --yes ajv-cli@5 validate \
              -s schemas/clients.schema.json \
              -d clients.json \
              --strict=false \
              --verbose
            echo "✅ Schema validation passed"
          else
            echo "⚠️  No schema found - skipping schema validation"
          fi

      - name: Run registry validator (if exists)
        shell: bash
        run: |
          set -euo pipefail
          if [ -f validate.sh ]; then
            echo "Running validate.sh..."
            chmod +x validate.sh
            ./validate.sh
            echo "✅ Custom validator passed"
          else
            echo "ℹ️  No validate.sh found - skipping"
          fi

      - name: Summary
        if: always()
        shell: bash
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Registry Validation Summary"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Total clients: $(jq '.total_clients' clients.json)"
          echo "Registry version: $(jq -r '.registry_version' clients.json)"
          echo "Last updated: $(jq -r '.last_updated' clients.json)"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
